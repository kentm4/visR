#' Method summarise
#' @param x placeholder
#' @export
vr_summarize <- function(x) UseMethod("vr_summarize")

#' Create variable summary for factors
#'
#' @param x placeholder
#'
#' @export
vr_summarize.factor <- function(x){
  x1 <- forcats::fct_explicit_na(x, na_level = "Missing")

  dat <- tibble::enframe(x1) %>%
    dplyr::group_by(value) %>%
    dplyr::summarise(N = dplyr::n()) %>%
    dplyr::mutate(`%` = round(100 * N/sum(N), 3)) %>%
    tidyr::pivot_wider(names_from = value, values_from = c("N", "%"), names_sep=" ") %>%
    as.list()
  list(dat)
}

#' Create variable summary for numeric variables
#'
#' @param x placeholder
#'
#' @export
vr_summarize.numeric <- function(x){
  dat <- list(
    mean = mean(x, na.rm = TRUE),
    min = min(x, na.rm = TRUE),
    Q1 = quantile(x, probs=0.25, na.rm = TRUE),
    median = median(x, na.rm = TRUE),
    Q3 = quantile(x, probs=0.75, na.rm = TRUE),
    max = max(x, na.rm = TRUE),
    sd = sd(x, na.rm = TRUE)
  )
  list(dat)
}

#' Create variable summary for all other variable types
#'
#' @param x placeholder
#'
#' @export
vr_summarize.default <- function(x){
  dat <- list(
    unique_values = length(unique(x)),
    nmiss = sum(is.na(x))
  )
  list(dat)
}

#' Create variable summary for table1
#' @param x placeholder
#' @export
vr_summarize_tab1 <- function(x) UseMethod("vr_summarize_tab1")

#' Create variable summary for factors
#'
#' @param x placeholder
#'
#' @export
vr_summarize_tab1.factor <- function(x){
  x1 <- forcats::fct_explicit_na(x, na_level = "Missing")
  
  dat <- tibble::enframe(x1) %>%
    dplyr::group_by(value) %>%
    dplyr::summarise(N = dplyr::n()) %>%
    dplyr::mutate(`n (%)` = paste0(
      N, " (",
      sprintf(100 * N/sum(N), fmt = '%#.1f'), "%)")
    ) %>%
    dplyr::select(-N) %>%
    tidyr::pivot_wider(names_from = value, values_from = c("n (%)"), names_sep=" ") %>%
    as.list()
  list(dat)
}

#' Create variable summary for numeric variables
#'
#' @param x placeholder
#'
#' @export
vr_summarize_tab1.numeric <- function(x){
  dat <- list(
    `Mean (SD)` = paste0(
      sprintf(mean(x, na.rm = TRUE), fmt = '%#.1f'), " (",
      sprintf(sd(x, na.rm = TRUE), fmt = '%#.1f'), ")"
    ),
    `Median (IQR)` = paste0(
      sprintf(median(x, na.rm = TRUE), fmt = '%#.1f'), " (",
      sprintf(quantile(x, probs = 0.25, na.rm = TRUE), fmt = '%#.1f'),  "-",
      sprintf(quantile(x, probs = 0.75, na.rm = TRUE), fmt = '%#.1f'),
      ")"),
    `Min-Max` = paste0(
      sprintf(min(x, na.rm = TRUE), fmt = '%#.1f'), "-",
      sprintf(max(x, na.rm = TRUE), fmt = '%#.1f')
    ),
    Missing = paste0(
      sum(is.na(x)), " (",
      sprintf(100 * sum(is.na(x))/dplyr::n(), fmt = '%#.1f'),
      "%)")
  )
  list(dat)
}

#' Create variable summary for all other variable types
#'
#' @param x placeholder
#'
#' @export
vr_summarize_tab1.default <- function(x){
  dat <- list(
    `Unique values` = length(unique(x)),
    `Missing (%)` = paste0(
      sum(is.na(x)), " (",
      sprintf(100 * sum(is.na(x))/dplyr::n(), fmt = '%#.1f'), "%)"
    )
  )
  list(dat)
}

#' Create a caption for any table
#'
#' @param caption The table caption
#' @param label Label
#' @param width Width
#'
#' @export
vr_table_caption <-function(caption,
         label = knitr::opts_current$get("label"),
         width = knitr::opts_current$get("out.width")) {
  asis_output(paste(
    '<table>',
    glue::glue(
      "<caption style=\"width:{width}px\">(#tab:{label}){caption}</caption>"
    ),
    '</table>',
    sep = ""
  ))
}

#' Create a caption for any table
#'
#' @param df The df
#' @param filename The filename
#' @param format What format. One of "txt", "tsv", "csv", "xlsx"
#' @param button What does the download button say
#'
#' @export
vr_table_download <- function(
  df, filename=NULL, format="csv", button="Download data"){

  if(!format %in% c("txt", "tsv", "csv", "xlsx")){
    stop("Output file format has to be either txt, tsv, csv or xlsx.")
  }

  if(is.null(knitr::opts_knit$get("fig.path"))){
    fp <- tempdir()
  }
  else{
    fp <- knitr::opts_knit$get("fig.path")
  }

  if(is.null(filename)){
    filename <- tempfile(pattern = paste("data-"), tmpdir = getwd(), fileext = paste0(".", format))
  }

  if(format %in% c("csv", "tsv", "txt")){
    delim <- switch(format, "csv" = ",", "tsv" = "\t", "txt" = " ")
    write.table(df, file = filename, sep = delim)
  }
  else{
    xlsx::write.xlsx(df, file=filename)
  }

  # String result ready to be placed in rmarkdown
  asis_output(paste0('<a class="btn btn-info" role="button" download="', filename, '" href="', filename, '">', button, '</a>'))
  # paste0('<button type="submit" onclick="window.open("', filename, '")">', button, '</button>')
}
